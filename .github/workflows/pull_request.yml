name: PULL REQUEST

on: 
  pull_request:
    types: [opened, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Decode base64 and parse JSON
        run: |
          echo ${{secrets.CREW_INFO_JSON}} | base64 --decode > decoded.json
          JSON_CONTENT=$(cat decoded.json | jq -c .)
          echo "$JSON_CONTENT"
          echo "CREW_INFO_JSON=$JSON_CONTENT" >> $GITHUB_ENV

      - name: Extract receiver list
        id: extract_receiver_list
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const excludeMember = context.payload.pull_request.user.login;
            const members = JSON.parse(process.env.CREW_INFO_JSON);
            console.log(members);
            let outputString = '';
            for (const member of members) {
              if (member.githubId !== excludeMember) {
                outputString += `<@${member.name}> `;
                console.log(member.name);
              }
            }
            return { slack_uid_list_without_specific_name: outputString.trim() };
          
      - name: pull_request_noifiy
        id: pull_request_notify
        uses: slackapi/slack-github-action@v1.26.0
        with: 
          channel-id: ${{vars.SLACK_CHANNEL_ID}}
          payload: |
            {
              "text": "âŒ›PRì™”ë‹¤ ë¦¬ë·°í•´ë¼âŒ›",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ“¬í”„ëŒë‹˜ì˜ PRì´ ë„ì°©í–ˆì–´ìš”.ğŸ“¬*\n\n\nâš¡âš¡âš¡âš¡âš¡âš¡âš¡âš¡âš¡\n*âš¡<https://github.com/koust6u/coduo-review/pull/2| [í”„ ëŒ] í˜¼êµ¬ë© ë‚´ëŸ¬ê°€ê¸°~>âš¡* \nâš¡âš¡âš¡âš¡âš¡âš¡âš¡âš¡âš¡\n\n _í˜¼ë‚´ì¤„ ì‚¬ëŒë“¤: <@${{steps.extract_receiver_list.output.slack_uid_list_without_specific_name}}>_\n"
                  }
                },
                {
                  "type": "divider"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
